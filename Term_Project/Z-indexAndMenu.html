<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Rectangular Albums</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            font-family: Arial, sans-serif;
        }

        #menu {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(255, 255, 255, 0.8);
            padding: 10px;
            border-radius: 8px;
        }

        #menu label, #menu input, #menu button {
            display: block;
            margin-bottom: 10px;
        }

    </style>
</head>
<body>
    <div id="menu">
        <label for="albumCount">Number of Albums:</label>
        <input type="number" id="albumCount" value="5" min="1" max="10">
        <label for="albumColor">Album Color:</label>
        <input type="color" id="albumColor" value="#0077ff">
        <label for="uploadImage">Upload Image:</label>
        <input type="file" id="uploadImage">
        <button id="generate">Generate Albums</button>
    </div>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three/build/three.module.js",
                "three/addons/": "https://unpkg.com/three/examples/jsm/",
                "tween": "https://cdnjs.cloudflare.com/ajax/libs/tween.js/18.6.4/tween.esm.js"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import TWEEN from 'tween';

        let scene, camera, renderer, controls;
        const albums = [];
        const tweens = [];

        init();
        animate();

        document.getElementById('generate').addEventListener('click', generateAlbums);

        function init() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0xaeaeae);

            const aspect = window.innerWidth / window.innerHeight;
            camera = new THREE.PerspectiveCamera(75, aspect, 0.1, 1000);
            camera.position.set(5, 5, 5);
            camera.lookAt(new THREE.Vector3(0, 0, 0));

            renderer = new THREE.WebGLRenderer();
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);

            controls = new OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.25;
            controls.screenSpacePanning = false;
            controls.minDistance = 10;
            controls.maxDistance = 100;
            controls.maxPolarAngle = Math.PI / 2;
            controls.rotateSpeed = 0.5;
            controls.zoomSpeed = 0.5;
            controls.panSpeed = 0.5;
            controls.mouseButtons = {
                LEFT: THREE.MOUSE.LEFT,
                MIDDLE: THREE.MOUSE.MIDDLE,
                RIGHT: null
            };

            const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
            scene.add(ambientLight);

            window.addEventListener('resize', onWindowResize);
            window.addEventListener('dblclick', onDoubleClick);
        }

        function generateAlbums() {
            const albumCount = parseInt(document.getElementById('albumCount').value, 10);
            const albumColor = document.getElementById('albumColor').value;
            const uploadImage = document.getElementById('uploadImage').files[0];

            if (!uploadImage) {
                alert("Please upload an image.");
                return;
            }

            const reader = new FileReader();
            reader.onload = function(event) {
                const imageSrc = event.target.result;
                const textureLoader = new THREE.TextureLoader();

                textureLoader.load(imageSrc, function(texture) {
                    albums.forEach(album => scene.remove(album.mesh));
                    tweens.forEach(tween => TWEEN.remove(tween));
                    albums.length = 0;
                    tweens.length = 0;

                    const geometry = new THREE.BoxGeometry(8, 6, 0.5);
                    const materials = [
                        new THREE.MeshStandardMaterial({ map: texture }), // front
                        new THREE.MeshStandardMaterial({ color: albumColor, opacity: 0.5, transparent: true }), // back
                        new THREE.MeshStandardMaterial({ color: albumColor, opacity: 0.5, transparent: true }), // top
                        new THREE.MeshStandardMaterial({ color: albumColor, opacity: 0.5, transparent: true }), // bottom
                        new THREE.MeshStandardMaterial({ color: albumColor, opacity: 0.5, transparent: true }), // right
                        new THREE.MeshStandardMaterial({ color: albumColor, opacity: 0.5, transparent: true })  // left
                    ];

                    const startZ = -(albumCount - 1) * 1.0 / 2;

                    for (let i = 0; i < albumCount; i++) {
                        const album = new THREE.Mesh(geometry, materials);
                        album.position.set(0, 0, startZ + i * 1.0);

                        const tween = new TWEEN.Tween(album.position)
                            .to({ y: [0.5, 0] }, 2000)
                            .interpolation(TWEEN.Interpolation.Bezier)
                            .repeat(Infinity)
                            .yoyo(true)
                            .start();

                        tweens.push(tween);
                        scene.add(album);
                        albums.push({ mesh: album });
                    }
                });
            };
            reader.readAsDataURL(uploadImage);
        }

        function onWindowResize() {
            const aspect = window.innerWidth / window.innerHeight;
            camera.aspect = aspect;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
            controls.update();
        }

        function animate() {
            requestAnimationFrame(animate);
            TWEEN.update();
            controls.update();
            renderer.render(scene, camera);
        }

        function onDoubleClick(event) {
            const mouse = new THREE.Vector2(
                (event.clientX / window.innerWidth) * 2 - 1,
                -(event.clientY / window.innerHeight) * 2 + 1
            );

            const raycaster = new THREE.Raycaster();
            raycaster.setFromCamera(mouse, camera);

            const intersects = raycaster.intersectObjects(albums.map(a => a.mesh));

            if (intersects.length > 0) {
                const intersected = intersects[0].object;
                const index = albums.findIndex(a => a.mesh === intersected);

                if (index >= 0) {
                    const album = albums.splice(index, 1)[0];
                    albums.push(album);

                    const sideMovement = 5;
                    new TWEEN.Tween(album.mesh.position)
                        .to({ x: album.mesh.position.x + sideMovement }, 500)
                        .easing(TWEEN.Easing.Cubic.Out)
                        .chain(
                            new TWEEN.Tween(album.mesh.position)
                                .to({ z: -albums.length + 1 }, 1000)
                                .easing(TWEEN.Easing.Cubic.InOut)
                                .chain(
                                    new TWEEN.Tween(album.mesh.position)
                                        .to({ x: album.mesh.position.x }, 500)
                                        .easing(TWEEN.Easing.Cubic.In)
                                )
                        )
                        .start();

                    albums.forEach((album, i) => {
                        if (i < albums.length - 1) {
                            new TWEEN.Tween(album.mesh.position)
                                .to({ z: -i * 1.0 }, 1000)
                                .start();
                        }
                    });
                }
            }
        }
    </script>
</body>
</html>
